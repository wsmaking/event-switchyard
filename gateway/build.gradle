plugins {
    id 'java'
    id 'application'
    id 'org.jetbrains.kotlin.jvm'
    id 'com.github.johnrengelman.shadow'
}

repositories { mavenCentral() }

java {
    toolchain { languageVersion = JavaLanguageVersion.of(21) }
}
kotlin {
    jvmToolchain(21)
}

dependencies {
    testImplementation libs.junit.jupiter
    testRuntimeOnly 'org.junit.platform:junit-platform-launcher'

    implementation platform("org.jetbrains.kotlin:kotlin-bom:2.0.20")
    implementation 'org.jetbrains.kotlin:kotlin-stdlib'

    implementation platform('com.fasterxml.jackson:jackson-bom:2.17.1')
    implementation 'com.fasterxml.jackson.core:jackson-databind'
    implementation 'com.fasterxml.jackson.module:jackson-module-kotlin'
    implementation 'com.fasterxml.jackson.module:jackson-module-afterburner'
    implementation 'com.fasterxml.jackson.datatype:jackson-datatype-jsr310'

    implementation 'ch.qos.logback:logback-classic:1.5.6'

    implementation 'org.apache.kafka:kafka-clients:3.5.1'

    // JNA - Rustネイティブライブラリ呼び出し用
    implementation 'net.java.dev.jna:jna:5.14.0'
}

tasks.withType(org.jetbrains.kotlin.gradle.tasks.KotlinCompile).configureEach {
    kotlinOptions {
        jvmTarget = '21'
    }
}

tasks.named('shadowJar') {
    archiveBaseName.set('gateway')
    archiveClassifier.set('all')
    mergeServiceFiles()
}

application {
    mainClass.set((findProperty('mainClass') ?: "gateway.MainKt") as String)
}

jar {
    manifest { attributes('Main-Class': application.mainClass.get()) }
    duplicatesStrategy = DuplicatesStrategy.EXCLUDE
}

tasks.named('test') {
    useJUnitPlatform()
    testLogging {
        showStandardStreams = true
        events "passed", "skipped", "failed"
    }
    // Panama (Foreign Function & Memory API) 用のJVMオプション
    jvmArgs '--enable-native-access=ALL-UNNAMED'
}

// =====================================================
// Rust ネイティブライブラリ ビルドタスク
// =====================================================

def rustProjectDir = file("${rootDir}/gateway-core")
def rustTargetDir = file("${rustProjectDir}/target/release")

// プラットフォーム別のライブラリ名
def nativeLibName = {
    def os = System.getProperty('os.name').toLowerCase()
    if (os.contains('mac')) return 'libgateway_core.dylib'
    if (os.contains('linux')) return 'libgateway_core.so'
    if (os.contains('win')) return 'gateway_core.dll'
    throw new GradleException("Unsupported OS: ${os}")
}()

task buildRust(type: Exec) {
    description = 'Build Rust gateway-core library'
    group = 'build'
    workingDir rustProjectDir
    commandLine 'cargo', 'build', '--release'

    // cargo がなければスキップ
    onlyIf {
        try {
            def result = ['which', 'cargo'].execute()
            result.waitFor()
            return result.exitValue() == 0
        } catch (Exception e) {
            return false
        }
    }
}

task copyRustLib(type: Copy) {
    description = 'Copy Rust library to resources'
    group = 'build'
    dependsOn buildRust

    from(rustTargetDir) {
        include nativeLibName
    }
    into("${projectDir}/src/main/resources/native")

    onlyIf {
        def libFile = new File(rustTargetDir, nativeLibName)
        libFile.exists()
    }
}

// processResources の前に Rust ライブラリをコピー
processResources.dependsOn copyRustLib
