Inflight制御 説明（圧縮版）

1. 目的
- 最優先は `queue_full_total=0`（深部崩壊の回避）。
- WAL/ディスク劣化時も、入口で制御して復帰可能な状態を維持する。

2. 手段
- `reserve`: 入口で受入可否を即時判定。
- `tick`: 動的に inflight limit を調整。
- 方針: 壊れる前に拒否して深部を守る。

3. 採用設定
- Normal: `CAP=1024, ALPHA=0.8, WAIT_US=200, BATCH=128`
- Degraded: `CAP=512, ALPHA=0.8, BATCH=1`
- 切替:
  - Normal -> Degraded: `wal_age_ms >= 550` 継続（60秒目安）など
  - Degraded -> Normal: `wal_age_ms < 200` 継続（5分目安）かつ `queue_full` 増分0

4. 実測要点（2026-02-14）
- A/B比較（各5回中央値）で `1024,0.8` が優位（throughput/p99/bpのバランス）。
- 境界再試験（`CAP=512,BATCH=1`）で reject は増えたが `queue_full=0` を維持。
- 切替検証（Normal -> Degraded -> Normal）で
  - 劣化時: `wal_age=745ms`, `limit=267` まで制御介入
  - 復帰時: `wal_age=0`, `limit=1024` に戻ることを確認

5. トレードオフ
- 得る: 深部保護、復帰容易性、運用判断の明確化。
- 失う: 劣化時の受理率（reject増）。
- 注意: `throughput` と `ack` は reject込みなので単独評価しない。

6. 一言
- 「劣化時は受理率より深部保護を優先し、回復後は通常設定へ戻す。」

7. 詰まりやすいポイント（追記）
- `throughput` が上がっても良化とは限らない:
  - reject を含むため、`rejected` とセットで評価する。
- `ack_p99` が低く見えても安心しない:
  - 早期rejectが増えると見かけ上は低下する。
- `wal_age` の瞬間値で切替しない:
  - 短いスパイクで誤切替しないよう、継続時間条件を必ず付ける。
- `queue_full=0` を最優先で見る:
  - 深部崩壊回避が最上位。受理率はその次。


圧縮：
WAL劣化時に無制限に受けると深部キューが飽和して崩壊するため、入口でinflightを制御しています。
inflightは「処理能力×許容遅延」で上限を決め、wal_ageを先行指標にlimitを動的に下げます。
主KPIはqueue_full=0で、劣化時はreject増を許容して深部を守り、復帰後に通常設定へ戻せることを実測で確認しました。
