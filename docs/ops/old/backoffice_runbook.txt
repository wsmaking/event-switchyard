# BackOffice Runbook (Minimal)

Purpose
- Provide a minimal recovery and verification checklist for the BackOffice service.

Prereqs
- BackOffice is running on `BACKOFFICE_URL` (default `http://localhost:8082`).
- JWT secret for the account (`JWT_HS256_SECRET`) is known.
- Kafka and Gateway are running if you want end-to-end checks.

Env (examples)
```
export BACKOFFICE_URL=http://localhost:8082
export BACKOFFICE_ACCOUNT_ID=acct_demo
export JWT_HS256_SECRET=dev-secret-change-me
export BACKOFFICE_STALE_SEC=120
export BACKOFFICE_DB_ENABLE=1
export BACKOFFICE_DB_URL=jdbc:postgresql://localhost:5432/backoffice
export BACKOFFICE_STRICT=0
export BACKOFFICE_PASSFAIL=1
export BACKOFFICE_REPLAY_SLO_MS=5000
```

1) Start / Restart
- Start BackOffice (and Kafka, Gateway if needed).
- On boot, BackOffice replays the ledger and prints replay stats in logs.

2) Recovery Check
- Use the recovery check script (health/stats/positions/balances/ledger/reconcile):
```
BACKOFFICE_JWT="<jwt>" scripts/ops/backoffice_recovery_check.sh
```
- If BACKOFFICE_JWT is not set, the script will generate a JWT from
  JWT_HS256_SECRET + BACKOFFICE_ACCOUNT_ID.
- BACKOFFICE_PASSFAIL=1 prints a final PASS/FAIL summary.

3) End-to-end Verification (optional)
- Place an order and check BackOffice state in one shot:
```
scripts/ops/gateway_backoffice_e2e.sh
```

3.5) Replay Verification (optional)
- Start BackOffice with a ledger replay and validate reconcile:
```
scripts/ops/backoffice_replay_verify.sh
```
- The script enforces `BACKOFFICE_REPLAY_SLO_MS` via `/stats` (durationMs).

4) RDB Standardization
- Production runs should enable Postgres (`BACKOFFICE_DB_ENABLE=1` or `BACKOFFICE_DB_URL` set).
- InMemory store is intended for dev-only; snapshotting runs only in that mode.

5) If Data Looks Stale
- Confirm consumer is enabled: `BACKOFFICE_ENABLE=1`
- Check `/stats` for `lastEventAt` and `lastKafkaOffset`.
- If offsets are not advancing, check Kafka connectivity and topic name.

6) If Ledger Replay Fails
- Inspect `var/backoffice/ledger.log` for malformed lines.
- Restart BackOffice after fixing any invalid entries.

Checklist (quick pass)
- /stats returns 200 and `lastEventAt` is recent.
- `ledgerReplay.durationMs` is within `BACKOFFICE_REPLAY_SLO_MS`.
- /positions and /balances return 200 for the account.
- /ledger returns entries for the account (limit=10).
- If any check fails, verify Kafka connectivity and `BACKOFFICE_ENABLE=1`.

Notes
- This runbook is intentionally minimal. Extend with alerting/metrics as needed.
